<%= content_for :pre_assets do %>
  <%= stylesheet_link_tag "/stylesheets/kehu.css" %>
<% end %>
<div class="content" id="content">
  <div class="main_top margin-left-0">
    <h2>客户列表</h2>
    <span class="margin-left-20 font-16 main_top_span">客户详情</span>
    <a class="back_to_list" href="index.html">
      <i class="fa-arrow-circle-left  fa"></i>
      返回列表
    </a>
  </div>

    <div class="details">
      <div class="details_nav">
      	<ul>
      		<li id="kehushow" class=""><a href="/mis/kehu/kehuliebiao/kehushow.html?kehushow" class="width-90">信息</a></li>
      		<li id="zichanzhanghu"><a href="/mis/kehu/kehuliebiao/zichanzhanghu.html?zichanzhanghu" class="width-90 ">资产账户</a></li>
      		<li id="cheliangdangan"><a href="/mis/kehu/kehuliebiao/cheliangdangan/show.html?cheliangdangan" class="width-90">车辆档案</a></li>
      		<li id="xiaofeijilu"><a href="/mis/kehu/kehuliebiao/xiaofeijilu.html?xiaofeijilu" class="width-90">消费记录</a></li>
      		<li id="huifangjilu"><a href="/mis/kehu/kehuliebiao/huifangjilu.html?huifangjilu" class="width-90">回访记录</a></li>
      		<li id="yixiang"><a href="/mis/kehu/kehuliebiao/yixiangchanpin.html?yixiang" class="width-90 ">意向产品</a></li>
      		<li id="tousu" class="active"><a href="/mis/kehu/kehuliebiao/tousu.html?tousu" class="width-90">投诉记录</a></li>
      		<li id="manyidu"><a href="/mis/kehu/kehuliebiao/manyidu.html?manyidu" class="width-90">满意度</a></li>
      	</ul>
      </div>

  <%= search_form_for @q, url: crm_store_customer_complaints_path(@customer), class: 'search navbar-form' do |f| -%>
      <div class="nav_query_wrap">
        <div class="nav-item-query">
          <label>选择车辆</label>
          <select class="width-120" name="q[store_vehicle_id_eq]">
            <option value="">全部车辆</option>
            <% @customer.plates.each do |plate| %>
              <option value="<%= plate.id%>" > <%= plate.license_number %> </option>
            <% end %>
          </select>
        </div>

        <div class="nav-item-query">
          <label>选择时间</label>
          <input type="date" class="width-120" name="q[created_at_gt]">
          <input type="date" class="width-120" name="q[created_at_lt]">
        </div>

        <div class="nav-item-query">
          <%= f.submit '查  询', class: 'btn query_btn' %>
        </div>
      </div>
    <% end -%>

      <div class="details_content">
        <table cellspacing="0" cellpadding="0" class="complaints">
          <thead>
            <tr>
              <th>#</th>
              <th>日期</th>
              <th>订单号</th>
              <th>内容</th>
              <th>金额</th>
              <th>开单</th>
              <th>施工</th>
              <th>投诉类别</th>
              <th>处理反馈</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @complaints.each_with_index do |complaint, i| %>
              <tr>
                <td class="number"> <%= i+1 %> </td>
                <td> <%= complaint.created_at_format %> </td>
                <td> <%= complaint.numero %> </td>
                <td> <%= complaint.content %> </td>
                <td> <%= complaint.amounts %> </td>
                <% saler = complaint.saler  %>
                <td> <%= StoreStaff.find(saler).full_name if saler %>  </td>
                <td>
                  <% complaint.mechanic.each do |m|  %>
                    <span> <%= StoreStaff.find(m).full_name %> </span>
                  <% end %>
                </td>
                <td>
                    <% complaint.categoried.each do |k, v|  %>
                        <%= complaint.category(k) %>
                    <% end %>
                </td>
                <td>
                  <%= complaint.customer %>
                </td>
                <td><i class="ico ico-edit do_complaints" data-customer="<%= @customer.id%>" data-complaint="<%= complaint.id%>" ></i></td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="12">
                  <label class="width-70">满意度:</label>
                  <span class="width-70"></span>
                  <label class="width-60">投诉:</label>
                  <span class="width-60"></span>
                  <label class="width-60">未处理:</label>
                  <span class="width-70"></span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

<div class="window_wrap" style="display:none;">
  <form  action="" method="post" id="complain_form" name="complain" >
    <input type="hidden" name="_method" value="put">
    <input type="hidden" name="complaint[id]" value="">
    <input type="hidden" name="complaint[store_customer_id]" value="">
    <input type="hidden" name="complaint[updator_id]" value="<%= current_staff.id%>">
    <div class="complaints_records_wrap">
  	<h2>投诉事件记录</h2>
  	<ul class="top">
  		<li>
  			<label>日期:</label>
  			<span id="created_at" ></span>
  		</li>
  	</ul>
  	<div class="complaints_records">
  		<dl class="client_base_info">
  	    <dd>客户名称</dd>
  			<dd> <%= @customer.full_name %> </dd>
  			<dd>联系方式</dd>
  			<dd> <%= @customer.phone_number %> </dd>
  			<dd>车牌号</dd>
  			<dd class="dd-vehicle" ></dd>
  			<dd>订单号</dd>
  			<dd class="dd-order-numero" ></dd>
  		</dl>
  		<dl class="client_type">
  	    <dd>投诉类别</dd>
  			<dd class="dd-category">
  	      <label>服务<input type="checkbox" value="1" name="complaint[detail][category][]" class="category-checkbox-1" ></label>
  				<label>质量<input type="checkbox" value="2" name="complaint[detail][category][]" class="category-checkbox-2" ></label>
  				<label>环境<input type="checkbox" value="3" name="complaint[detail][category][]" class="category-checkbox-3" ></label>
  				<label>其他<input type="checkbox" value="4" name="complaint[detail][category][]" class="category-checkbox-4" ></label>
  			</dd>
  			<dd>投诉渠道</dd>
  			<dd class="dd-way">
  				<label>电话<input type="checkbox" name="complaint[detail][way][]" value="1" class="way-checkbox-1" ></label>
  				<label>现场<input type="checkbox" name="complaint[detail][way][]" value="2" class="way-checkbox-2" ></label>
  				<label>微信<input type="checkbox" name="complaint[detail][way][]" value="3" class="way-checkbox-3" ></label>
  				<label>短信<input type="checkbox" name="complaint[detail][way][]" value="4" class="way-checkbox-4" ></label>
  			</dd>
  		</dl>
  		<dl class="opinion">
  	    <dd>客诉内容</dd>
  			<dd>
  			  <textarea id="complaint-content" name="complaint[detail][content]" ></textarea>
  			</dd>
  		</dl>
  		<dl class="opinion">
  	    <dd>调查结果</dd>
  			<dd><textarea id="complaint-inquire" name="complaint[detail][inquire]" ></textarea></dd>
  		</dl>

  		<dl class="opinion">
  	    <dd>责任人</dd>
  			<dd>
  			  <div class="liable_person">
  					<h2>销售接待</h2>
  					<ul id="complaint-saler">
  					</ul>
  				</div>
  				<div class="liable_person">
  					<h2>施工技师</h2>
  					<ul id="complaint-mechanic">
  					</ul>
  				</div>
  			</dd>
  		</dl>

  		<dl class="opinion">
  	    <dd>处理结果</dd>
  			<dd>
  				<dl class="result">
            <dd>客户</dd>
  					<dd>责任人</dd>
  				</dl>
  				<dl class="result">
            <dd><textarea id="response-customer" name="complaint[detail][response][customer]" ></textarea></dd>
  					<dd><textarea id="response-principal" name="complaint[detail][response][principal]" ></textarea></dd>
  				</dl>

  			</dd>
  		</dl>

  		<dl class="opinion">
  			<dd>反馈</dd>
  			<dd>
  				<div class="liable_person">
  					客户对处理方式满意
  				</div>
  				<div class="liable_person text-align-right">
  					<ul>
  						<li><label>满意<input type="checkbox" name="complaint[satisfaction]" class="satisfaction-1" value="1"></label></li>
  						<li><label>不满意<input type="checkbox" name="complaint[satisfaction]" class="satisfaction-2" value="2"></label></li>
  					</ul>
  				</div>
  			</dd>
  		</dl>
    </div>

  	<div class="btn_group">
      <a href="javascript:void(0)" class="btn cancel_btn">取消</a>
      <input type="submit" name="name" value="确定" class="btn save_btn">
  	</div>
  </div>
</form>
</div>
</div>

<% content_for :javascripts do %>
<script type="text/javascript">
jQuery(function($){
  $(document).on("click", "i.ico.ico-edit.do_complaints", function(){
    $("input:checkbox").prop("checked", false);
    $("div.window_wrap").show();
    var customer = $(this).data("customer");
    var complaint = $(this).data("complaint");
    $("input[name='complaint[id]']").val(complaint);
    $("input[name='complaint[store_customer_id]']").val(customer);
    $('form#complain_form').attr('action', "/crm/store_customers/"+ customer +"/complaints/"+ complaint +"");
    $.get("/crm/store_customers/"+ customer +"/complaints/"+ complaint +"/edit", function(data){
      $("dd.dd-vehicle").text(data.license_number);
      $("dd.dd-order-numero").text(data.numero);
      data.categoried.forEach(function(item){
        $("input.category-checkbox-" + item).prop("checked",'true')
      });
      data.way.forEach(function(item){
        $("input.way-checkbox-" + item).prop("checked",'true')
      });
      $("textarea#complaint-content").text(data.content);
      $("textarea#complaint-inquire").text(data.inquire);
      $("ul#complaint-saler").append("<li><label>"+ data.salers[0].name +"<input name='complaint[detail][principal][saler]' type='checkbox' value="+ data.salers[0].id +" ></label></li>")
      if(data.salers[0].select == data.salers[0].id){
        $("input[name='complaint[detail][principal][saler]']").prop("checked","true")
      };
      data.mechanics.forEach(function(item){
        $("ul#complaint-mechanic").append("<li><label>"+ item.name +"<input name='complaint[detail][principal][mechanic][]' type='checkbox' class='mechanic-"+ item.id +"' value=" + item.id + "></label></li>");
      });
      data.mechanic.forEach(function(item){
        $("input.mechanic-"+ item).prop("checked",'true');
      });
      $("textarea#response-customer").text(data.responses[0].customer);
      $("textarea#response-principal").text(data.responses[0].principal);
      $("input.satisfaction-"+data.satisfaction).prop("checked",'true');
      $("span#created_at").text(data.created_at);
    });
  });

  $("a.btn.cancel_btn").on("click", function(){
    $("div.window_wrap").hide();
    $("ul#complaint-saler").html("");
    $("ul#complaint-mechanic").html("");
  });

});
</script>
<% end %>
