<% content_for :pre_assets do %>
  <%= javascript_include_tag 'kucun' %>
<% end %>

<div class="main_top">
  <span class="add_span">+</span>
</div>
<div class="details">
  <div class="details_nav"><%= render partial: 'kucun/materials/material_settings_url' %></div>
    <div class="details_nav_second">
      <ul class="goods_nav">
        <li><a href="#" class="width-90">▲上一件商品</a></li>
        <li><a href="#" class="width-90">▼下一件商品</a></li>
        <li ><a href="#" class="width-90">返回列表</a></li>
      </ul>
    </div>
    <div class="details_content">
      <div class="base_info"><%= render 'form' %></div>
    </div>
</div>

<% content_for :javascripts do %>
  <script>
    jQuery(function(){
      var new_service_tmpl = JST['kucun/saleinfos/new/form'];
      var show_tmpl = JST['kucun/saleinfos/new/summary'];
      var form_url = "<%= kucun_material_saleinfo_saleinfo_services_path(material_id: @store_material.id) %>"
      var store_commission_templates = <%= @store_commission_templates.to_json.html_safe %>
      services = [];
      $("input[name='saleinfo[volume]']").on('change', function(){
        if(this.value){
          var x = (this.dataset.costpirce/this.value).toFixed(2);
          $('#divided_cost').val(x + '元/' + $("select[name='saleinfo[unit]'").val())
        }
      });

      $("select[name='saleinfo[unit]'").on('change', function(){
        var m = $("input[name='saleinfo[volume]']")[0];
        if(m.value){
          var x = (m.dataset.costpirce/m.value).toFixed(2);
          $('#divided_cost').val(x + '元/' + this.value)
        }
      });

      $('[name="saleinfo[service_fee_needed]"]').on('change', function(){
         if(this.dataset.target){
          $("[name='saleinfo[service_fee]']").removeAttr('disabled');
         }else{
          $("[name='saleinfo[service_fee]']").attr('disabled', true);
         }
      });

      $("input[name='saleinfo[service_needed]']").on('change', function(){
        if(this.checked){
          $('#add_server_btn').removeClass('disabled');
        }else{
          $('#add_server_btn').addClass('disabled');
        }
      });

      $('#add_server_btn').on('click', function(){
        if(this.classList.contains('disabled')){
          return false;
        }
        this.classList.add('disabled');
        var id = services.length + 1;
        var service = {id: id}
        services.push(service);
        var cloned = JSON.parse(JSON.stringify(service));
        cloned.store_commission_templates = store_commission_templates;
        $('div.server_list').append(new_service_tmpl(cloned));
      });

      $('div.server_list').on('click', 'input.save_service', function(){
        var $form = $(this.parentNode.parentNode);
        var id = $form.data('id');
        obj = services.filter(function(ser){ return ser.id == id})[0];
        obj.name = $form.find('[name="saleinfo[store_material_saleinfo_services][][name]"]').val();
        obj.times = $form.find('[name="saleinfo[store_material_saleinfo_services][][times]"]').val();
        obj.work_time = $form.find("[name='saleinfo[store_material_saleinfo_services][][work_time]']").val();
        obj.mechanic_level = $form.find('[name="saleinfo[store_material_saleinfo_services][][mechanic_level]"]').val();
        $.post(form_url, obj, function (data) {
          console.log(data)
        });
        if(!obj.saved){
          obj.saved = true;
          $('#lists').append(show_tmpl(obj)).show();
        }else{
          $(`[data-id="service_${obj.id}"]`).html(show_tmpl(obj));
        }
        $form.hide();
        $('#add_server_btn').removeClass('disabled');
      });

      $("#lists").on('click','.click_btn', function(){
        $("[data-id='"+this.dataset.editformid+"']").show();
      });
    });
  </script>
<% end %>
