
<div class="main_top">
  <span class="add_span">+</span>
</div>
<div class="details">
  <div class="details_nav"><%= render partial: 'kucun/materials/material_settings_url' %></div>
    <div class="details_nav_second">
      <ul class="goods_nav">
        <li><a href="#" class="width-90">▲上一件商品</a></li>
        <li><a href="#" class="width-90">▼下一件商品</a></li>
        <li ><a href="#" class="width-90">返回列表</a></li>
      </ul>
    </div>
    <div class="details_content">
      <div class="base_info"><%= render 'form' %></div>
    </div>
</div>

<% content_for :scenes do %>
  <div class="list_new_page_wrap do_create_ticheng_window" style='display:none;' id="commission_tempalte_detail"></div>
<% end %>

<% content_for :javascripts do %>
  <script>
    jQuery(function(){
      var detail_tmpl = JST['kucun/commissions/new/detail'];

      var form_url = "<%= kucun_material_saleinfo_path(material_id: @store_material.id) %>"
      var store_commission_templates = <%= json_for(@store_commission_templates).html_safe %>;
      views = {};
      services = [];
      $("input[name='saleinfo[volume]']").on('change', function(){
        if(this.value){
          var x = (this.dataset.costpirce/this.value).toFixed(2);
          $('#divided_cost').val(x + '元/' + $("select[name='saleinfo[unit]'").val())
        }
      });

      $("select[name='saleinfo[unit]'").on('change', function(){
        var m = $("input[name='saleinfo[volume]']")[0];
        if(m.value){
          var x = (m.dataset.costpirce/m.value).toFixed(2);
          $('#divided_cost').val(x + '元/' + this.value)
        }
      });

      $('[name="saleinfo[service_fee_needed]"]').on('change', function(){
         if(this.dataset.target){
          $("[name='saleinfo[service_fee]']").removeAttr('disabled');
         }else{
          $("[name='saleinfo[service_fee]']").attr('disabled', true);
         }
      });

      $("input[name='saleinfo[service_needed]']").on('change', function(){
        if(this.checked){
          $('#add_server_btn').removeClass('disabled');
        }else{
          $('#add_server_btn').addClass('disabled');
        }
      });

      $('#add_server_btn').on('click', function(){
        if(this.classList.contains('disabled')){
          return false;
        }
        this.classList.add('disabled');
        var service_view = new $$MIS.SaleinfoServiceView({
          model: new $$MIS.SaleinfoService()
        });

        service_view.store_commission_templates = store_commission_templates;
        $('div.server_list').append(service_view.render().el);
        service_view.idx = $('#lists').find('.list_content').length + 1;
        views[service_view.cid] = service_view;

        service_view.on('created', function(){
          $('#lists').append(service_view.show()).show();
          service_view.$el.hide();
          $('#add_server_btn').removeClass('disabled');
          service_view.summary_el = $('#lists').find("div[data-viewid='"+ service_view.cid +"']");
          services.push(service_view.model);
        });

        service_view.on('updated', function(){
          service_view.summary_el.html(service_view.summary())
          service_view.$el.hide();
          $('#add_server_btn').removeClass('disabled');
        });
      });


      $("#lists").on('click','.click_btn', function(){
        $('#add_server_btn').addClass('disabled');
        var service_view = views[this.dataset.viewid];
        service_view.$el.show();
      });

      $('#main').on('click', '.detail', function(){
        var select = $(this).siblings('select')[0];
        if(select.value){
            var data = $(select.options[select.selectedIndex]).data('template');
            $("#commission_tempalte_detail").html(detail_tmpl(data)).show();
        }else{
          ZhanchuangAlert('请选择一个方案');
        }
      });

      $("#commission_tempalte_detail").on('click', '.do_cancel, .cancel_btn', function(){
        $('#commission_tempalte_detail').hide();
      });

      $("#saleinfo_form").on('submit', function(evt){
        evt.preventDefault();
        var formdata = $(this).serializeJSON();
        formdata.saleinfo.services_attributes = services.map(function(model, idx, collection, undef){
          return model.attributes;
        });

        $.ajax({
          url: form_url,
          dataType: 'json',
          type : 'POST',
          contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
          data: formdata,
          success:function(data){
            window.location.replace('/kucun/materials/<%= @store_material.id %>/saleinfo')
          },
          error: function(){
            ZhanchuangAlert('系统错误，请重试。');
          }
        })

        return false;
      });
    });
  </script>
<% end %>
