<% content_for :pre_assets do %>
  <%= javascript_include_tag 'kucun/materials/new' %>
<% end %>

<div class="main_top">
        <h2>库存列表</h2>
        <span class="add_span">+</span>
      </div>
      <div class="details">
        <div class="container_list">
          <div class="top_content records">
            <%= render partial: 'table_head' %>
          </div>
          <div class="details_nav">
            <ul>
              <li class="bg-color-fff"><a href="#" class="width-90">商品信息</a></li>

              <li class='ext_info'><a href="javascript:void(0);" onclick="alert(this.dataset.alert);" data-alert='请先保存商品信息！' class="width-90">销售设置</a></li>
              <li class='ext_info'><a href="javascript:void(0);" onclick="alert(this.dataset.alert);" data-alert='请先保存商品信息！' class="width-90">提成</a></li>
              <li class='ext_info'><a href="javascript:void(0);" onclick="alert(this.dataset.alert);" data-alert='请先保存商品信息！' class="width-90">回访</a></li>

            </ul>
          </div>
          <div class="details_nav_second">
            <ul class="goods_nav">
              <li><a href="#" class="width-90">▲上一件商品</a></li>
              <li><a href="#" class="width-90">▼下一件商品</a></li>
              <li ><a href="#" class="width-90">返回列表</a></li>
            </ul>
          </div>
          <div class="details_content"><%= render 'form' %></div>
        </div>
      </div>

<% content_for :scenes do %>
  <div id='piccut'>
    <div class="overlay">
  		<div class="overlay-inner"></div>
  	</div>
  	<div id='arrange'>
  	  <div id='gallery' style="top: -1px; left: 115px;" class="resize-container"></div>
  	</div>
    <div class="btn_group">
      <input type="file" id='imgfile' name="imgefile" size="12" accept="image/jpeg,image/png" />
      <button class="crop_btn btn-crop js-crop">截图</button>
      <input class="cancel_btn btn-cancel js-cancel" type="button" value="取消"/>
    </div>
  </div>
<% end %>

<% content_for :javascripts do %>
<script>
  jQuery(function($){
    v = new $$MIS.NewMaterialView();
    v.setElement('#new_material');
    v.model = new $$MIS.Material();
    v.model.on('invalid', v.invalid_handle);
    v.category_collection = new  $$MIS.MaterialCategoryCollection();
    v.model.view = v;

    $('#new_material').on('submit', function(evt){
        evt.preventDefault();
        evt.stopPropagation();
        var $this = $(this);
        if($this.data('error')){return false;}
        if(!v.model.isValid()){return false;}

        v.model.save()
               .success(function(data){
                 var url = v.model.url() + '/save_picture';
                 $('#preview_list > img').each(function(idx){
                    var img = this;
                    $.ajax({
                            type: "POST",
                            url: url,
                            sync: false,
                            data: {img: img.src},
                            success: function(data){console.log(data)},
                            dataType: 'text'
                          });
                 });
                 $('#modal_dialog').html('save successfully!').dialog({
                    modal: true,
                    buttons: {
                      Ok: function() {
                        $( this ).dialog( "close" );
                      }
                    }
                  });
                  window.location.replace(v.model.url());
                })
              .error(function(data){alert('error')});
        return false;
    });
  });
</script>

<script>
 jQuery(function($) {
   $( "input.autocomplete" ).autocomplete({
     source: function( request, response ) {
       $.ajax({
         url: "/kucun/materials/autocomplete_name",
         dataType: "jsonp",
         data: {
           q: request.term
         },
         success: function( data ) {
           response( data );
         }
       });
     },
     minLength: 3,
     select: function( event, ui ) {
       console.log( ui.item ?
         "Selected: " + ui.item.label :
         "Nothing selected, input was " + this.value);
     },
     open: function() {
       $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
     },
     close: function() {
       $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
     }
   });
 });
 </script>
<% end %>
