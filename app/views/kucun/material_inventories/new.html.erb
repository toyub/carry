<% content_for :pre_assets do %>
  <%= javascript_include_tag 'kucun/materials/new' %>
<% end %>

      <div class="main_top">
        <h2>入库</h2>
        <span class="add_span">+</span>
      </div>
      <div class="details">
        <div class="in_storage_list list_table">
            <div class="search_nav">
              <div class="item-query">
                <label>入库方式</label>
                <input type="hidden" name='material[in_store_type_id]' value="">
                <span id='in_store_type_id' class="width-157 as_select" data-select='#in_store_type_select' data-target='input[name="material[in_store_type_id]"]'>按订单入库</span>
                <div id='in_store_type_select' class="select width-165">
                  <ol class="width-165">
                    <li data-value="1"><a href="javascript:void(0)">按订单入库</a></li>
                    <li data-value="2"><a href="/kucun/transfer/receipts/new">转移入库</a></li>
                    <li data-value="3"><a href="/kucun/jits/new">按商品入库</a></li>
                  </ol>
                </div>
              </div>
              <div class="item-query">
                <label>查找订货单</label>
                <select type="text" class="width-150">
                  <option></option>
                  <option></option>
                </select>
              </div>
              <div class="item-query">
                <label>供应商</label>
                <select id='store_supplier_id' name='store_supplier_id' type="text" class="width-150">
                  <%= options_from_collection_for_select(@store.store_suppliers, :id, :name, params[:store_supplier_id]) %>
                </select>
              </div>
              <div class="item-query">
               <a href="#" class="query_btn btn">查<nbsp2></nbsp2>询</a>
              </div>
              <div class="query_div">
               <a  href="index.html" class="in_stg_btn btn">入库</a>
               <a  href="jilu.html" class="notes_btn btn">记录</a>
              </div>
            </div>
            <div class="in_storage common_storage by_orders">
              <div class="list">
                <div class="list_top list_tr">
                  <ul>
                    <li>#</li>
                    <li>时间</li>
                    <li>订货单号</li>
                    <li>订货商</li>
                    <li>金额</li>
                    <li>明细</li>
                    <li>操作</li>
                  </ul>
                </div>
                <div class="list_contents">

                  <% @store_material_orders.each_with_index do |order, idx| %>
                  <div class="list_content list_tr border_left">
                      <ul>
                        <li><%= idx + 1%>.</li>
                        <li><%= order.created_at.to_s(:date_only) %></li>
                        <li><%= order.numero %></li>
                        <li><%= order.store_supplier.name %></li>
                        <li><%= order.amount %></li>
                        <li class='items' data-items='<%= json_for(order.store_material_order_items) %>'>
                          <%= order.store_material_order_items.first.store_material.name %>
                          <i class="fa fa-chevron-down chevrondow chevron float-right"></i>
                        </li>
                        <li><input type="checkbox" data-id='<%= order.id %>' data-supplier='<%= order.store_supplier.name %>' data-order='<%= order.to_json %>' name="sub_check"></li>
                      </ul>
                  </div>
                 <% end %>
               </div>
              </div>
          </div>
        </div>

        <div class="in_storage_content common_storage_content float-left  margin-bottom-50 margin-top-80">
          <%= form_tag '/kucun/material_inventories', id: 'rukuruku' do %>
          <input type="hidden" id='order_id' name='order_id'/>
          <div class="in_storage_query">
            <div class="nav-item-query">
              <div class="font-20 font-borderradius text-align-center">入</div>
            </div>
            <div class="nav-item-query">
              <label>时间：</label>
              <input type="text" class="width-135" value="<%= Time.now.to_s(:date_only) %>" readonly>
            </div>
            <div class="nav-item-query">
              <label>单号：</label>
              <input type="text" class="width-135" value="<%= make_numero("IN") %>" readonly>
            </div>
            <div class="nav-item-query">
              <label>供应商：</label>
              <input id='order_supplier' type="text" value="" class="width-240" readonly>
            </div>
            <div class="nav-item-query">
              <label>数量：</label>
              <input id='total_quantity' type="text" class="width-135" readonly>
            </div>
            <div class="nav-item-query">
              <label>金额：</label>
              <input id='total_amount' type="text" class="width-135" readonly>
            </div>
            <div class="in_storage_print">
              <a href="#" class="print_btn">打<nbsp1></nbsp1>印</a>
              <a href="#" class="print_barcode_btn">打印条码</a>
            </div>
          </div>
          <div class="in_storage_tab common_storage_tab">
            <table cellpadding="0" cellspacing="0" id="storage_tab" class="check_order storage_tab" data-depots='<%= @store.store_depots.to_json %>'>
              <thead>
                <tr class="bg-color-e0e2cf color-282726">
                  <th>#</th>
                  <th>商品名称</th>
                  <th>条码</th>
                  <th>规格</th>
                  <th>单位</th>
                  <th>一级分类</th>
                  <th>二级分类</th>
                  <th>单价</th>
                  <th>订货数量</th>
                  <th>入库数量</th>
                  <th>仓库</th>
                  <th>小计</th>
                  <th>操作</th>
                  <th>备注</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
            <div class="common_storage_account">
              <div class="item_content margin-left-10" >
                <label class="width-75">备注：</label>
                <textarea class="remarks_textarea"></textarea>
              </div>
              <div class="item_content  margin-left-10">
                <label class="width-75">制单人：</label>
                <label class="width-253"><%= current_user.screen_name %></label>
              </div>
            </div>
          </div>
          <div class="btn_group">
            <a id='submit' class="in_stg_btn" href="javascript:void(0);" >入库</a>
          </div>
          <% end %>
      </div>
  </div>

<%= content_for :scenes do %>
  <div id='order_items' class='storage_details' style="display:none"></div>
<% end %>

<% content_for :javascripts do %>
  <script>
    Date.parse1 = function(str){return new Date(Date.parse(str));}
    Date.prototype.cn_date = function(){return this.getFullYear() + '年' + ( this.getMonth() + 1 ) + '月' + this.getDate() + '日'}
    function calc_total() {
      var _total_quantity=0,
          _total_amount = 0;
      $('#storage_tab > tbody > tr').each(function(){
        var _input = this.cells[9].children[0];
        var quantity = parseInt(_input.value);
        _total_quantity += quantity;
        _total_amount += (_input.dataset.price*quantity);
      });
      $("#total_amount").val(_total_amount.toFixed(2));
      $("#total_quantity").val(_total_quantity);
    }
    jQuery(function(){
      var tm = JST['kucun/material_inventories/new/inventoryitem'];
      var boxdd = null;
      $('.list').on('change', 'input[type=checkbox]', function(event){
           if(this.checked){
             if(boxdd && boxdd!=this){
               boxdd.checked = false;
             }
             boxdd = this;
             var order = $(this).data('order');
             var html = '';
             $("#order_id").val(order.id);
             $("#total_amount").val(order.amount);
             $("#total_quantity").val(order.quantity);
             $("#order_supplier").val(this.dataset.supplier);
             var items = $('input:checked').parent().siblings('.items').data('items')
             items.forEach(function(item){
               html += tm({item: item, store_depots: $('#storage_tab').data('depots')})
            });
            $("#storage_tab > tbody").html(html);
         }else{
           $("#storage_tab > tbody").html('');
         }
      });

      $('#storage_tab').on('click', 'i.lnr-trash', function(event){
        var tr = $(this).closest('tr');
        var id=tr[0].dataset.id;
        var order_id = $("#order_id").val();
        tr.remove();
        calc_total();
        if($('#storage_tab > tbody').children().length < 1){
          $('input[data-id="'+order_id+'"]').removeAttr('checked');
        }
      });

      $('#storage_tab').on('dblclick', 'input.quantity', function(){
        this.readOnly=false;
      });

      $('#storage_tab').on('input', 'input.quantity', function(){
        var tr = $(this).closest('tr');
        var amount = (this.value * this.dataset.price).toFixed(4)
        tr.find('.amount').html(amount);
        calc_total();
      });

      $("#submit").on('click', function(){
        if($("#storage_tab > tbody > tr").length < 1){
          ZhanchuangAlert('未选择任何商品进行入库！');
        }else{
          $('#rukuruku').submit();
        }
      });

      $('.list_contents').on('click', '.items', function(evt){
        evt.stopPropagation();
        $('.list_contents').find('.to_hide').removeClass('to_hide');
        this.classList.add('to_hide');
        var b_c_r = this.getBoundingClientRect();
        var item_width=338;
        var pop_width=400;
        var x = JST['kucun/material_inventories/new/orderitems']({items: $(this).data("items")})
        $("#order_items").html(x).css({
          top: b_c_r.top + b_c_r.height,
          left: b_c_r.left - (pop_width-item_width)
        }).show();
      });
      $('.list_contents').on('click', '.to_hide', function(evt){
        evt.stopPropagation();
        this.classList.remove('to_hide');
        $("#order_items").hide();
      });
      
      $("#order_items").on('click', function(evt){
        evt.stopPropagation();
      });

      $(document).on('click', function(){
        $('.list_contents').find('.to_hide').removeClass('to_hide');
        $("#order_items").hide();
      });

      $("#store_supplier_id").select2();
    });
  </script>
<% end %>
